<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com -->
<!-- vim: set ts=2: -->
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>JS-XLSX Live Demo</title>
		<style>
		#drop{
			border:2px dashed #bbb;
			-moz-border-radius:5px;
			-webkit-border-radius:5px;
			border-radius:5px;
			padding:25px;
			text-align:center;
			font:20pt bold,"Vollkorn";color:#bbb
		}
		#b64data{
			width:100%;
		}
		</style>
	</head>
	<body>


		<div id="drop">Drop a spreadsheet file here to see sheet data</div>
		<p><input type="file" name="xlfile" id="xlf" /> ... or click here to select a file</p>
		
		<p>
			TAFFY query examples / notes:
			<pre>
sheets["2018-10"]({"COURSE": {like:"AGRI"}}).count();
sheets["2018-10"]({"COURSE": {like:"AGRI"}}).first();
sheets["2018-10"]({"DEPT": "AGRI"}).first();

			</pre>
		</p>
		<pre id="out"></pre>
		<br />
		<script src="js/js-xlsx/shim.js"></script>
		<script src="js/taffydb/taffy.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.9.1/xlsx.full.min.js"></script>
		<script>
		    /*jshint browser:true */
		    /*global XLSX */
		    var X = XLSX;
		    var XW = {
			    /* worker message */
			    msg: 'xlsx',
			    /* worker scripts */
			    rABS: './js/js-xlsx/xlsxworker2.js',
			    norABS: './js/js-xlsx/xlsxworker1.js',
			    noxfer: './js/js-xlsx/xlsxworker.js'
		    };

		    var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
		    var use_worker = false;

		    var transferable = use_worker;

		    var wtf_mode = false;

		    function fixdata(data) {
			    var o = "", l = 0, w = 10240;
			    for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));
			    o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));
			    return o;
		    }

		    function ab2str(data) {
			    var o = "", l = 0, w = 10240;
			    for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
			    o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
			    return o;
		    }

		    function s2ab(s) {
			    var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
			    for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
			    return [v, b];
		    }

		    function xw_noxfer(data, cb) {
			    var worker = new Worker(XW.noxfer);
			    worker.onmessage = function(e) {
				    switch(e.data.t) {
					    case 'ready': break;
					    case 'e': console.error(e.data.d); break;
					    case XW.msg: cb(JSON.parse(e.data.d)); break;
				    }
			    };
			    var arr = rABS ? data : btoa(fixdata(data));
			    worker.postMessage({d:arr,b:rABS});
		    }

		    function xw_xfer(data, cb) {
			    var worker = new Worker(rABS ? XW.rABS : XW.norABS);
			    worker.onmessage = function(e) {
				    switch(e.data.t) {
					    case 'ready': break;
					    case 'e': console.error(e.data.d); break;
					    default: xx=ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"); console.log("done"); cb(JSON.parse(xx)); break;
				    }
			    };
			    if(rABS) {
				    var val = s2ab(data);
				    worker.postMessage(val[1], [val[1]]);
			    } else {
				    worker.postMessage(data, [data]);
			    }
		    }

		    function xw(data, cb) {
			    if(transferable) xw_xfer(data, cb);
			    else xw_noxfer(data, cb);
		    }

		    function get_radio_value( radioName ) {
			    var radios = document.getElementsByName( radioName );
			    for( var i = 0; i < radios.length; i++ ) {
				    if( radios[i].checked || radios.length === 1 ) {
					    return radios[i].value;
				    }
			    }
		    }

		    function to_json(workbook) {
			    var result = {};
			    workbook.SheetNames.forEach(function(sheetName) {
				    var roa = X.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
				    if(roa.length > 0){
					    result[sheetName] = roa;
				    }
			    });
			    return result;
		    }

		    function to_csv(workbook) {
			    var result = [];
			    workbook.SheetNames.forEach(function(sheetName) {
				    var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
				    if(csv.length > 0){
					    result.push("SHEET: " + sheetName);
					    result.push("");
					    result.push(csv);
				    }
			    });
			    return result.join("\n");
		    }

		    function to_shaun(workbook) {
			    var result = [];
			    window.sheets = {};
			    workbook.SheetNames.forEach(function(sheetName) {
				    var csv = X.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
				    if(csv.length > 0){
					    result.push("READING SHEET: " + sheetName);
					    result.push(csv.length + " RECORDS.");
					    result.push("");

					    // Iterate over each row to tidy up the data.
						    for (var i = 1; i < csv.length; i++) {
							    // Use Object.assign() to fill in missing fields from previous record.
								    if (!csv[i]['COURSE']) {
									    Object.assign(csv[i], csv[i-1]);
									    console.log("Filling in the gaps on record " + i + " = " + csv[i-1]['COURSE']);
								    }
							    
							    /* Split COURSE (DEPT*341*001) into three columns for easier queries. */
							    [csv[i]['DEPT'], csv[i]['NUMBER'], csv[i]['SECT']] = csv[i]["COURSE"].split("*");
							    
							    /* Split course time into STARTTIME and ENDTIME for easier queries. */
							    if (csv[i]["O.TIME"]) {
								    [csv[i]['STARTTIME'], csv[i]['ENDTIME']] = csv[i]["O.TIME"].split("-");
							    } else {
								    [csv[i]['STARTTIME'], csv[i]['ENDTIME']] = [undefined, undefined];
							    }
								    
						    }
					    
					    window.sheets[sheetName] = TAFFY(csv);

					    result.push("DISTINCT DEPARTMENTS: ");
					    result.push(window.sheets[sheetName]({DEPT: {isUndefined: false}}).distinct("DEPT").join("\n"));
					    result.push("");
					    /* result.push(window.sheets[sheetName]({STARTTIME: {isUndefined: false}}).distinct("STARTTIME").sort().join("\n ")); */
					    window.csv = csv;
				    }
			    });
			    return result.join("\n");
		    }

		    function to_formulae(workbook) {
			    var result = [];
			    workbook.SheetNames.forEach(function(sheetName) {
				    var formulae = X.utils.get_formulae(workbook.Sheets[sheetName]);
				    if(formulae.length > 0){
					    result.push("SHEET: " + sheetName);
					    result.push("");
					    result.push(formulae.join("\n"));
				    }
			    });
			    return result.join("\n");
		    }

		    var tarea = document.getElementById('b64data');
		    function b64it() {
			    if(typeof console !== 'undefined') console.log("onload", new Date());
			    var wb = X.read(tarea.value, {type: 'base64',WTF:wtf_mode});
			    process_wb(wb);
		    }

		    function process_wb(wb) {
			    var output = "";
			    output = to_shaun(wb);
			    
			    if(out.innerText === undefined) out.textContent = output;
			    else out.innerText = output;
			    if(typeof console !== 'undefined') console.log("output", new Date());
		    }

		    var drop = document.getElementById('drop');
		    function handleDrop(e) {
			    e.stopPropagation();
			    e.preventDefault();
			    // rABS = document.getElementsByName("userabs")[0].checked;
			    // use_worker = document.getElementsByName("useworker")[0].checked;
			    var files = e.dataTransfer.files;
			    var f = files[0];
			    {
				    var reader = new FileReader();
				    var name = f.name;
				    reader.onload = function(e) {
					    if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
					    var data = e.target.result;
					    if(use_worker) {
						    xw(data, process_wb);
					    } else {
						    var wb;
						    if(rABS) {
							    wb = X.read(data, {type: 'binary'});
						    } else {
							    var arr = fixdata(data);
							    wb = X.read(btoa(arr), {type: 'base64'});
						    }
						    process_wb(wb);
					    }
				    };
				    if(rABS) reader.readAsBinaryString(f);
				    else reader.readAsArrayBuffer(f);
			    }
		    }

		    function handleDragover(e) {
			    e.stopPropagation();
			    e.preventDefault();
			    e.dataTransfer.dropEffect = 'copy';
		    }

		    if(drop.addEventListener) {
			    drop.addEventListener('dragenter', handleDragover, false);
			    drop.addEventListener('dragover', handleDragover, false);
			    drop.addEventListener('drop', handleDrop, false);
		    }


		    var xlf = document.getElementById('xlf');
		    function handleFile(e) {
			    //rABS = document.getElementsByName("userabs")[0].checked;
			    var files = e.target.files;
			    var f = files[0];
			    {
				    var reader = new FileReader();
				    var name = f.name;
				    reader.onload = function(e) {
					    if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
					    var data = e.target.result;
					    if(use_worker) {
						    xw(data, process_wb);
					    } else {
						    var wb;
						    if(rABS) {
							    wb = X.read(data, {type: 'binary'});
						    } else {
							    var arr = fixdata(data);
							    wb = X.read(btoa(arr), {type: 'base64'});
						    }
						    process_wb(wb);
					    }
				    };
				    if(rABS) reader.readAsBinaryString(f);
				    else reader.readAsArrayBuffer(f);
			    }
		    }

		    if(xlf.addEventListener) xlf.addEventListener('change', handleFile, false);
		</script>
		<script type="text/javascript">
		    var _gaq = _gaq || [];
		    _gaq.push(['_setAccount', 'UA-36810333-1']);
		    _gaq.push(['_trackPageview']);

		    (function() {
			    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		    })();
		</script>
	</body>
</html>
